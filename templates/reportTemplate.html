<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>취약점 리포트 - {{vuln_type}}</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 30px;
      }
      h1 {
        color: #c0392b;
      }
      .severity {
        font-weight: bold;
        color: #d35400;
      }
      .box {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 10px;
      }
      .download-btn {
        background-color: #2c3e50;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        margin-bottom: 20px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <button class="download-btn" onclick="downloadPDF()">
      📄 PDF 다운로드
    </button>

    <h1>🛡️ 탐지된 취약점: {{vuln_type}}</h1>
    <p class="severity">위험도: {{severity}}</p>
    <p>설명: {{description}}</p>

    <p><strong>Report Generated At:</strong> {{generated_time}}</p>
    <p id="generated-time" style="display: none">{{generated_time}}</p>

    <div class="box">
      <h3>요청 URL</h3>
      <p>{{url}}</p>

      <h3>HTTP 메서드</h3>
      <p>{{method}}</p>

      <h3>사용된 페이로드</h3>
      <p>{{payload}}</p>

      <h3>응답 코드</h3>
      <p>{{response_status}}</p>
    </div>

    <!-- ✅ JSON 데이터 삽입 -->
    <script id="json-data" type="application/json">
      {{json_data}}
    </script>

    <!-- PDF 변환 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });

        const generatedTime =
          document.getElementById("generated-time")?.innerText || "Unknown";

        // === 1. 표지 페이지 ===
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(26);
        pdf.setTextColor(0);

        const titleText = "SECURITY VULNERABILITY REPORT";
        const pageWidth = pdf.internal.pageSize.getWidth();
        const titleWidth = pdf.getTextWidth(titleText);
        const titleX = (pageWidth - titleWidth) / 2;
        pdf.text(titleText, titleX, 60);

        pdf.setFontSize(20);
        pdf.text("- Report Generated By: llm_intheloop", 18, 105);
        pdf.text("- Detection Status   : Vulnerability Detected", 18, 120);
        pdf.text(`- Report Generated At: ${generatedTime}`, 18, 135);

        // 설명 구간
        pdf.setDrawColor(180);
        pdf.line(20, 220, 190, 220);

        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(11);
        pdf.setTextColor(60);
        const descLines = [
          "This document contains the analysis result",
          "of security vulnerabilities detected during",
          "dynamic web fuzzing analysis.",
          "",
          "Please handle this document with caution.",
        ];
        pdf.text(descLines, 20, 230);

        pdf.setFontSize(10);
        pdf.setTextColor(150);
        pdf.text("© 2025 llm_intheloop", 20, 285);

        // === 2. HTML 내용 스크린샷 ===
        pdf.setTextColor(0);
        pdf.addPage();

        const element = document.body;
        const canvas = await html2canvas(element);
        const imgData = canvas.toDataURL("image/jpeg");

        const imgProps = pdf.getImageProperties(imgData);
        const ratio = imgProps.width / imgProps.height;
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdfWidth / ratio;

        pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);

        // === 3. JSON 원본 삽입 페이지 ===
        const jsonEl = document.getElementById("json-data");
        if (jsonEl) {
          const json = JSON.parse(jsonEl.textContent);
          const jsonStr = JSON.stringify(json, null, 2);
          const lines = pdf.splitTextToSize(jsonStr, 180);

          pdf.addPage();
          pdf.setFontSize(10);
          pdf.text(lines, 10, 20);
        }

        // === 저장 ===
        const filename = window.location.pathname
          .split("/")
          .pop()
          .replace(".html", ".pdf");
        pdf.save(filename);
      }
    </script>
  </body>
</html>
