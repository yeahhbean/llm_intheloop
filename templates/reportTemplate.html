<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ì·¨ì•½ì  ë¦¬í¬íŠ¸ - {{vuln_type}}</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 30px;
      }
      h1 {
        color: #c0392b;
      }
      .severity {
        font-weight: bold;
        color: #d35400;
      }
      .box {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 10px;
      }
      .download-btn {
        background-color: #2c3e50;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        margin-bottom: 20px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <button class="download-btn" onclick="downloadPDF()">
      ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ
    </button>

    <h1>ğŸ›¡ï¸ íƒì§€ëœ ì·¨ì•½ì : {{vuln_type}}</h1>
    <p class="severity">ìœ„í—˜ë„: {{severity}}</p>
    <p>ì„¤ëª…: {{description}}</p>

    <p><strong>Report Generated At:</strong> {{generated_time}}</p>
    <p id="generated-time" style="display: none">{{generated_time}}</p>

    <div class="box">
      <h3>ìš”ì²­ URL</h3>
      <p>{{url}}</p>

      <h3>HTTP ë©”ì„œë“œ</h3>
      <p>{{method}}</p>

      <h3>ì‚¬ìš©ëœ í˜ì´ë¡œë“œ</h3>
      <p>{{payload}}</p>

      <h3>ì‘ë‹µ ì½”ë“œ</h3>
      <p>{{response_status}}</p>
    </div>

    <!-- âœ… JSON ë°ì´í„° ì‚½ì… -->
    <script id="json-data" type="application/json">
      {{json_data}}
    </script>

    <!-- PDF ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });

        const generatedTime =
          document.getElementById("generated-time")?.innerText || "Unknown";

        // === 1. í‘œì§€ í˜ì´ì§€ ===
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(26);
        pdf.setTextColor(0);

        const titleText = "SECURITY VULNERABILITY REPORT";
        const pageWidth = pdf.internal.pageSize.getWidth();
        const titleWidth = pdf.getTextWidth(titleText);
        const titleX = (pageWidth - titleWidth) / 2;
        pdf.text(titleText, titleX, 60);

        pdf.setFontSize(20);
        pdf.text("- Report Generated By: llm_intheloop", 18, 105);
        pdf.text("- Detection Status   : Vulnerability Detected", 18, 120);
        pdf.text(`- Report Generated At: ${generatedTime}`, 18, 135);

        // ì„¤ëª… êµ¬ê°„
        pdf.setDrawColor(180);
        pdf.line(20, 220, 190, 220);

        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(11);
        pdf.setTextColor(60);
        const descLines = [
          "This document contains the analysis result",
          "of security vulnerabilities detected during",
          "dynamic web fuzzing analysis.",
          "",
          "Please handle this document with caution.",
        ];
        pdf.text(descLines, 20, 230);

        pdf.setFontSize(10);
        pdf.setTextColor(150);
        pdf.text("Â© 2025 llm_intheloop", 20, 285);

        // === 2. HTML ë‚´ìš© ìŠ¤í¬ë¦°ìƒ· ===
        pdf.setTextColor(0);
        pdf.addPage();

        const element = document.body;
        const canvas = await html2canvas(element);
        const imgData = canvas.toDataURL("image/jpeg");

        const imgProps = pdf.getImageProperties(imgData);
        const ratio = imgProps.width / imgProps.height;
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdfWidth / ratio;

        pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);

        // === 3. JSON ì›ë³¸ ì‚½ì… í˜ì´ì§€ ===
        const jsonEl = document.getElementById("json-data");
        if (jsonEl) {
          const json = JSON.parse(jsonEl.textContent);
          const jsonStr = JSON.stringify(json, null, 2);
          const lines = pdf.splitTextToSize(jsonStr, 180);

          pdf.addPage();
          pdf.setFontSize(10);
          pdf.text(lines, 10, 20);
        }

        // === ì €ì¥ ===
        const filename = window.location.pathname
          .split("/")
          .pop()
          .replace(".html", ".pdf");
        pdf.save(filename);
      }
    </script>
  </body>
</html>
